@page "/BattleField"
@using BlazorGame.Shared
@inject HttpClient Http
@inject IStateService StateService
@inject IUnitService UniteService
@inject Radzen.DialogService DialogService
@inject TooltipService tooltipService

@if (StateService.TotalUnits.Count != 0)
{
    <div class="row">
        <div class="col-lg-6 col-md-4 col-sm-12">
            <RadzenCard>
                <h3 class="h5">Your Hero</h3>
                <RadzenDataGrid AllowFiltering="false" RowClick="@RowSelect" AllowPaging="false"
                            AllowSorting="true" Data="@StateService.TotalUnits" TItem="Unit" ColumnWidth="50px"
                            SelectionMode="DataGridSelectionMode.Single" @bind-Value=@selectedUnits>
                    <Columns>
                        <RadzenDataGridColumn TItem="Unit" Property="Photo" Title="Hero" Sortable="false" Filterable="false">
                            <Template Context="data">
                                <RadzenImage Path="@($"img/{data.Title}.jpg")" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 8px;" />
                                @data.Name
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Unit" Property="HitPoint" Title="HP" />
                        <RadzenDataGridColumn TItem="Unit" Property="Attack" Title="Attack" />
                        <RadzenDataGridColumn TItem="Unit" Property="Defense" Title="Defense" />
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </div>
        <div class="col-lg-6 col-md-4 col-sm-12">
            <RadzenCard>
               
                    <div > <h3 class="h5">STEP 1 : Generate Com-Monsters</h3></div>
                     <div class="row">
                    <div class = "col-9" > 
                        
                             <RadzenButton Image="img/Com.jpg" Click ="@GenerateMoster" ButtonStyle="ButtonStyle.Secondary">
                            @if (StateService.TotalMonsters.Count() > 0)
                            {
                                <span class="rz-button-text">Re-generate Com-Monsters</span>
                            }
                            else
                            {
                                  <span class="rz-button-text">Generate Com-Monsters</span>
                            }
                            
                    </RadzenButton>
                        
                    </div>
                   
                       <div class = "col-3" > 
                           @if (StateService.TotalMonsters.Count() > 0)
                            {
                             <RadzenButton Click ="@ClearMosters" ButtonStyle="ButtonStyle.Danger" >
                            
                                <span class="rz-button-text">
                                    Clear</span>
                           
                         
                    </RadzenButton>
                        }
                    </div>

                </div>
               
                @if (StateService.IsMonsterGenerated)
                {
                    
                    <RadzenDataGrid AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="false"
                            AllowSorting="true" Data="@StateService.TotalMonsters" TItem="Unit" ColumnWidth="50px"
                            SelectionMode="DataGridSelectionMode.Single" >
                        <Columns>
                            <RadzenDataGridColumn TItem="Unit" Property="Photo" Title="Hero" Sortable="false" Filterable="false">
                                <Template Context="data">
                                 
                                       @{switch (StateService.gameLevel)
                                    {
                                         case(GameLevel.Intermediate):

                                              <RadzenImage Path="@($"img/monster{data.Title}.jpg")" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 8px;" />
                                                <span>XX-@data.Title</span>
                                            break;

                                    case(GameLevel.Easy):
                                          <RadzenImage Path="@($"img/monster{data.Title}.jpg")" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 8px;" />
                                            <span>@data.Name-@data.Title</span>
                                    break;

                                    default:
                                            <RadzenImage Path="@($"img/question.png")" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 8px;" />
                                            <span>XX - XX</span>
                                            break;

                                    }
                                    }
                                      
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Unit" Property="HitPoint" Title="HP" >
                                <Template  Context="data">
                                @if (StateService.gameLevel!=GameLevel.Easy)
                                {
                                    <span>??</span>
                                }
                                else
                                {
                                <span>@data.HitPoint</span>
                                }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Unit" Property="Attack" Title="Attack">
                                  <Template  Context="data">
                                @if (StateService.gameLevel !=GameLevel.Easy)
                                {
                                  <span>??</span>
                                }  
                                  else
                                {
                                <span>@data.Attack</span>
                                }
                                 </Template>

                                  </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Unit" Property="Defense" Title="Defense" >
                                  <Template  Context="data">
                                    @if (StateService.gameLevel !=GameLevel.Easy)
                                {
                                  <span>??</span>
                                }
                                  else
                                {
                                <span>@data.Defense</span>
                                }
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }


            </RadzenCard>
        </div>
    </div>

    @if (StateService.IsMonsterGenerated)
    {

        <div class="row flex-row-reverse">

            <div class="col-lg-6 col-md-4 col-sm-12  ">
                <RadzenCard >
                    <h3 class="h5">STEP 2 ：Choose difficulty</h3>
                    <RadzenRadioButtonList @bind-Value=@gameLevel TValue="GameLevel" Disabled="@StateService.DisableLevel"  Change=@((args) => OnLevelChange(args))>
                        <Items>
                            <RadzenRadioButtonListItem Text="Easy"  Value="GameLevel.Easy" Style="color: blue; margin-left: 8px; vertical-align: middle;"  />
                            <RadzenRadioButtonListItem Text="Intermediate" Value="GameLevel.Intermediate" Style="color: green; margin-left: 8px; vertical-align: middle;"  />
                            <RadzenRadioButtonListItem Text="Hard" Value="GameLevel.Hard" Style="color: orange; margin-left: 8px; vertical-align: middle;"  />
                            <RadzenRadioButtonListItem Text="Expert" Value="GameLevel.Expert" Style="color: red; margin-left: 8px; vertical-align: middle;"  />
                        </Items>
                    </RadzenRadioButtonList>        
                      <RadzenCard Class="mt-4">
               <p>
                   detail : @StateService.LevelExplanation.ElementAt((int)gameLevel)

               </p>
            </RadzenCard>

                </RadzenCard>
            </div>
        </div>
          <div class="row flex-row-reverse">

            <div class="col-lg-6 col-md-4 col-sm-12  ">
                <RadzenCard >
                    <h3 class="h5">STEP 3 ： Let's Fight some monsters</h3>
                   <RadzenButton  Text="FIGHT" Icon="warning_amber" ButtonStyle="ButtonStyle.Warning" />
                </RadzenCard>
            </div>
        </div>

    }

    @if (selectedUnits != null)
    {
        <div class="row my-4 ">
            <div class="col-lg-1 col-md-4 col-sm-12">
                <RadzenImage Path="@($"img/{selectedUnits[0].Title}.jpg")" style="width: 80px; height: 80px; border-radius: 8px; margin-right: 8px;" />
                HP :   @selectedUnits[0].HitPoint
            </div>
            <div class="col-lg-10 col-md-4 col-sm-12">
                <RadzenCard>
                    <h4 class="mb-4">Strength Value</h4>
                    <RadzenSlider Disabled="true" @bind-Value="@value" TValue="int" Min="0" Max="100" class="w-100" />
                </RadzenCard>
            </div>
            <div class="col-lg-1 col-md-4 col-sm-12">
                <RadzenImage Path="@($"img/wizard.jpg")" style="width: 80px; height: 80px; border-radius: 8px; margin-right: 8px;" />
                HP: 80
            </div>
        </div>
    }
}


@code {
    private WeatherForecast[]? forecasts;
    private IList<Unit> selectedUnits { get; set; }
    private int value = 50;
    private GameLevel gameLevel;
    protected override async Task OnInitializedAsync()
    {
        forecasts = await Http.GetFromJsonAsync<WeatherForecast[]>("WeatherForecast");
        StateService.OnChange += StateHasChanged;

    }

    async Task GenerateMoster()
    {
        if (StateService.TotalMonsters.Count() > 1)
        StateService.TotalMonsters.Clear();
        
        BusyDialog();
        await Task.Delay(1);
        StateService.TotalMonsters  = await UniteService.GeneraterMosterList();
        StateService.IsMonsterGenerated = true;
       StateService.DisableLevel = !StateService.IsMonsterGenerated;
        DialogService.Close();
    }

  async Task BusyDialog()
    {
        await DialogService.OpenAsync("", ds =>
    @<div>
                        <div class="row">
                            <div class="col text-center p-5">
                                <RadzenImage Path="img/buzy.gif" Style="display: block; width: 200px; margin-bottom: 40px;" />
                               @* <b>Loading, please wait...</b>*@
                            </div>
                        </div>
    </div>
    , new DialogOptions() { ShowTitle = false, Style = "min-height:auto;min-width:auto;width:auto", CloseDialogOnEsc = false });
    }

    void OnLevelChange(GameLevel level)
    {

        StateService.gameLevel = level;


    }

    void RowSelect(DataGridRowMouseEventArgs<Unit> RowSelected)
    {
        var num = ((double)RowSelected.Data.HitPoint / (RowSelected.Data.HitPoint + 80)) * 100;
        value = Convert.ToInt32(Math.Round(num, 0));


    }

    void ShowTooltip(ElementReference elementReference, TooltipOptions options = null) => tooltipService.Open(elementReference, "Some content", options);

    public void ClearMosters()
    {
        StateService.TotalMonsters.Clear();
        StateService.IsMonsterGenerated = false;
        StateService.DisableLevel = !StateService.IsMonsterGenerated;
    }
    public void Dispose()
    {

        StateService.OnChange -= StateHasChanged;

    }
}


